<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18/build/css/intlTelInput.css">
<title>Rita & Jo√£o | Confirma√ß√£o de Presen√ßa</title>
<link rel="stylesheet" href="style_rsvp.css">
</head>

<body>
<div class="form-card">
  <div class="form-content">
    <h2>Confirma√ß√£o de Presen√ßa</h2>
    <form id="rsvpForm">
	  <input type="text" name="website" id="website" tabindex="-1" autocomplete="off" class="hp">
	  <input type="hidden" name="startTime" id="startTime">
      <div class="form-grid">
        <label for="nome">Nome *</label>
        <input type="text" name="nome" id="nome" placeholder="Nome" required>
		
        <label for="presenca">Presen√ßa *</label>
        <select name="presenca" id="presenca" required>
          <option value="Sim" selected>Sim</option>
          <option value="N√£o">N√£o</option>
        </select>
		
		<label for="contacto" class="campo-extra">Contacto *</label>
        <input type="tel" name="contacto" id="contacto" placeholder="Contacto" class="campo-extra">

        <label for="num_pessoas" class="campo-extra num_pessoas">N√∫mero de pessoas *</label>
        <input type="number" value="1" name="num_pessoas" id="num_pessoas" placeholder="N√∫mero de pessoas" min="1" class="campo-extra">

        <label for="nomes" class="campo-extra">Nomes dos acompanhantes *</label>
        <input type="text" name="nomes" id="nomes" placeholder="Ex: Ana, Maria, (incluir nomes das crian√ßas)" class="campo-extra">
		  
		<label for="pequenoCafe" class="campo-extra">Pequeno-almo√ßo *</label>
		<select name="pequeno_cafe" id="pequenoCafe" class="campo-extra">
		  <option value="Sim" selected>Sim</option>
		  <option value="N√£o">N√£o</option>
		</select>

        <label for="criancas" class="campo-extra">Leva crian√ßas? *</label>
        <select name="criancas" id="criancas" class="campo-extra">
          <option value="N√£o">N√£o</option>
          <option value="Sim">Sim</option>
        </select>

        <label for="idadesCriancas" class="campo-extra">Quantas e qual a idade? *</label>
        <input type="text" name="idades_criancas" id="idadesCriancas" placeholder="Ex: 2 crian√ßas - 4 e 7 anos" class="campo-extra">

        <label for="restricoes" class="campo-extra">Restri√ß√µes alimentares (opcional)</label>
        <textarea name="restricoes" id="restricoes" placeholder="Ex: intoler√¢ncias alimentares, dieta, vegetariano " class="campo-extra"></textarea>

        <button type="submit" class="enviar">Enviar confirma√ß√£o</button>
        <button type="button" class="voltar" onclick="voltarAoConvite()">‚Üê Voltar ao convite</button>

        <p class="mensagem" id="msg"></p>
      </div>
    </form>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18/build/js/utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18/build/js/intlTelInput.min.js"></script>
<script>
let iti;
document.addEventListener("DOMContentLoaded", () => {
  iti = intlTelInput(document.querySelector("#contacto"), {
    initialCountry: "pt",
    separateDialCode: true
  });
  document.body.style.opacity = 0;
  setTimeout(() => { document.body.style.opacity = 1; }, 50);
  atualizarCampos();
  document.getElementById("startTime").value = Date.now();
});

// ===== Campos din√¢micos =====
const form = document.getElementById("rsvpForm");
const presenca = document.getElementById("presenca");
const camposExtras = document.querySelectorAll(".campo-extra");
const criancas = document.getElementById("criancas");
const idades = document.getElementById("idadesCriancas");
const msg = document.getElementById("msg");
const numPessoasInput = document.getElementById("num_pessoas");
const nomesInput = document.getElementById("nomes");

function atualizarCampos() {
  const numPessoas = parseInt(numPessoasInput.value) || 1;
  // Seleciona o container do intl-tel-input
  const indicativoContainer = document.querySelector("#contacto")?.closest(".iti");
  camposExtras.forEach(c => {
    if(presenca.value === "N√£o") {
      c.classList.add("hidden");
      indicativoContainer.classList.add("hidden");
      if(c.tagName !== "LABEL") c.required = false;
    } else {
	  // Campo "Leva crian√ßas" (criancas) s√≥ aparece se numPessoas > 1
      if(c === criancas || (c.tagName === "LABEL" && c.htmlFor === "criancas")) {
        const mostrar = numPessoas > 1;
        c.classList.toggle("hidden", !mostrar);
        if(c.tagName !== "LABEL") c.required = mostrar;
      }
      // Idades das crian√ßas
      else if(c === idades || (c.tagName === "LABEL" && c.htmlFor === "idadesCriancas")){
        const obrigatorio = criancas.value === "Sim";
        c.classList.toggle("hidden", !obrigatorio);
        if(c.tagName !== "LABEL") c.required = obrigatorio;
      }
      // Nomes acompanhantes
      else if(c === nomesInput || (c.tagName === "LABEL" && c.htmlFor === "nomes")){
        const ocultar = numPessoas <=1;
        c.classList.toggle("hidden", ocultar);
        if(c.tagName !== "LABEL") c.required = !ocultar;
      }
	  else if(c === contacto || (c.tagName === "LABEL" && c.htmlFor === "contacto")){
        const obrigatorio = presenca.value === "Sim";
        c.classList.toggle("hidden", !obrigatorio);
        if(c.tagName !== "LABEL") c.required = obrigatorio;
      }
      else {
        c.classList.remove("hidden");
		indicativoContainer.classList.remove("hidden");
        if(c.name === "num_pessoas" || c.name === "criancas") c.required = true;
		if(c.tagName !== "LABEL") c.required = (c.name === "pequeno_cafe") ? true : c.required;
      }
    }
  });
}

presenca.addEventListener("change", atualizarCampos);
criancas.addEventListener("change", atualizarCampos);
numPessoasInput.addEventListener("input", atualizarCampos);
document.addEventListener("DOMContentLoaded", atualizarCampos);

// ===== Valida√ß√£o nomes =====
function validarNomesComAcompanhantes(nomePrincipal, nomesAcompanhantes, numPessoas){
  if(numPessoas <= 1) return true;
  const arr = nomesAcompanhantes.split(",").map(n=>n.trim()).filter(n=>n.length>0);
  return (1 + arr.length) === numPessoas;
}

form.addEventListener("submit", async function(e){
	  // Honeypot
	if (form.website && form.website.value !== "") {
	  return; // spam silencioso
	}
  
  const startTime = Number(form.startTime.value);
  if (!startTime || Date.now() - startTime < 3000) {
     return; // bot demasiado r√°pido
  }
  
  e.preventDefault();
  //msg.textContent = "";
  // Mostrar loading imediatamente
  msg.textContent = "‚è≥ A enviar confirma√ß√£o‚Ä¶";
  msg.style.color = "#333";  // cor neutra para loading

  // Desativa o bot√£o para evitar m√∫ltiplos cliques
  const btn = form.querySelector("button.enviar");
  btn.disabled = true;
try {
  // 1Ô∏è‚É£ Preparar dados
  const formData = Object.fromEntries(new FormData(form));
  formData.token = "rsvp-rita-joao-2026";
  const numPessoas = parseInt(formData.num_pessoas) || 1;

  if(formData.presenca === "Sim"){
    if(!iti.isValidNumber()){
      alert("Contacto inv√°lido. Verifique o n√∫mero.");
	  btn.disabled = false;
       msg.textContent = "";
      return;
    }

    const dadosPais = iti.getSelectedCountryData();
    const numeroInternacional = iti.getNumber();

    formData.prefixo = `+${dadosPais.dialCode}`;
    formData.contacto_completo = numeroInternacional.replace(/\D/g,''); // remove +, espa√ßos, etc.
    //formData.contacto = numeroInternacional.replace(/\D/g,'').slice(dadosPais.dialCode.length);
	const existe = await verificarDuplicado(formData.contacto_completo);
	if(existe){
	  alert("Este contacto j√° confirmou presen√ßa.");
	  btn.disabled = false;
      msg.textContent = "";
	  return; // BLOQUEIA envio
	}

    // 2Ô∏è‚É£ Validar nomes se houver acompanhantes
    if(numPessoas > 1){
      const arr = (formData.nomes || "").split(",").map(n=>n.trim()).filter(n=>n.length>0);
      if(1 + arr.length !== numPessoas){
        alert(`O n√∫mero de nomes n√£o corresponde ao n√∫mero de pessoas, que s√£o ${numPessoas}.`);
		btn.disabled = false;
        msg.textContent = "";
        return;
      }
    }
	if(numPessoas === 1) {
	  delete formData.criancas;
	  delete formData.idades_criancas; // remove tamb√©m idades, se houver
	}
  }
  if(formData.presenca !== "Sim") {
		delete formData.contacto;
		delete formData.criancas;
		delete formData.idades_criancas;
		delete formData.nomes;
		delete formData.num_pessoas;
		delete formData.restricoes;
		delete formData.prefixo;
		delete formData.pequeno_cafe; // <- campo novo
	}

  // 3Ô∏è‚É£ Enviar para Apps Script
  
    const resp = await fetch("https://script.google.com/macros/s/AKfycby91JQ3LKZ_2rnrEeycyLLTGwf5min8KkCurbmQATzarOmHa3GuAELx6VUzBNHCWt-BKw/exec", {
      method: "POST",
      body: JSON.stringify(formData)
    });

    const texto = await resp.text();
    let result;
    try { result = JSON.parse(texto); } catch { throw new Error("Resposta inv√°lida"); }

    // 4Ô∏è‚É£ Verificar duplicado
    if(result.status === "duplicate"){
      alert("Este contacto j√° confirmou presen√ßa.");
	  btn.disabled = false;
      msg.textContent = "";
      return;
    }

    if(result.status === "error"){
      alert(result.message || "Erro ao enviar");
	  btn.disabled = false;
       msg.textContent = "";
      return;
    }

    if(result.status === "ok"){
      //alert("Confirma√ß√£o registada! A redirecionar...");
	  if(formData.presenca === "Sim"){
		msg.textContent = "‚úÖ Que alegria saber que estar√£o connosco! Obrigado por fazerem parte deste dia t√£o especial.";
		msg.style.color = "green";
		form.reset();
		atualizarCampos();
		//voltarAoEnvelope();
		setTimeout(voltarAoEnvelope, 7000);
	  } else {
		msg.textContent = "‚úÖ Compreendemos a vossa aus√™ncia e agradecemos desde j√° o carinho.";
		msg.style.color = "black";
		setTimeout(voltarAoEnvelope, 7000);
	   }
    }

  } catch(err){
    console.error(err);
    alert("Erro de comunica√ß√£o com o servidor");
	btn.disabled = false;
    msg.textContent = "";
  }
});

// ===== Voltar =====
function voltarAoConvite(){
	document.body.style.opacity=0; 
	setTimeout(()=>{window.location.href="index.html#convite";},1000);
}
function voltarAoEnvelope(){
	setTimeout(() => {
    document.body.style.opacity = 0;
    setTimeout(() => {
      window.location.href = "index.html";
    }, 2000); // tempo do fade
  }, 100); // pequeno delay ap√≥s fechar o alert
}
async function verificarDuplicado(contactoCompleto) {
  try {
    const resp = await fetch("https://script.google.com/macros/s/AKfycby91JQ3LKZ_2rnrEeycyLLTGwf5min8KkCurbmQATzarOmHa3GuAELx6VUzBNHCWt-BKw/exec", {
      method: "POST",
      body: JSON.stringify({
        acao: "verificar",
        contacto_completo: contactoCompleto.replace(/\D/g,''), // normaliza tamb√©m
		token: "rsvp-rita-joao-2026",     // üîê OBRIGAT√ìRIO
        startTime: Date.now() - 5000     // ‚è±Ô∏è simula humano
      })
    });

	if (!resp.ok) throw new Error("Erro HTTP");
    const texto = await resp.text();
    const result = JSON.parse(texto);

    return result.exists;

  } catch (err) {
    console.error("Erro verificarDuplicado:", err);
    return false; // em caso de erro, deixa passar
  }
}

</script>
</body>
</html>











































