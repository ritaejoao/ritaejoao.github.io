<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18/build/css/intlTelInput.css">
<title>Rita & Jo√£o | Confirma√ß√£o de Presen√ßa</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; font-family:'Georgia', serif; }
body { background-color: #f6f5ef; display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px; opacity:0; transition: opacity 0.8s ease; }

.form-card { width:100%; max-width:520px; background-image:url('convite-mobile.png'); background-size:cover; background-position:center; border-radius:18px; padding:80px 45px 50px; box-shadow:0 12px 40px rgba(0,0,0,0.18); position:relative; }
.form-content { text-align:center; }
.form-grid { display:grid; grid-template-columns:1fr; gap:12px; margin-top:20px; }
label { display:block; font-weight:bold; margin-bottom:4px; font-size:14px; color:#333; text-align:left; }
input, select, textarea { width:100%; padding:12px 14px; border-radius:30px; border:1px solid rgba(0,0,0,0.25); font-family:inherit; font-size:15px; background: rgba(255,255,255,0.85); }
textarea { resize:none; height:75px; }
button { cursor:pointer; font-size:16px; padding:12px 0; border-radius:30px; margin-top:8px; }
button.enviar { background:#6b8f71; color:white; border:none; }
button.enviar:hover { background:#557a5e; }
button.voltar { background: rgba(255,255,255,0.75); color:#6b8f71; border:1px solid #6b8f71; }
button.voltar:hover { background:#6b8f71; color:white; }
.hidden { display:none; }
.mensagem { font-size:14px; margin-top:10px; color:green; }
/* Remove sombra e fundo da bandeira */
.iti__selected-flag {
  /*box-shadow: none !important;
  background: transparent !important;*/
  border-radius:30px 0 0 30px;
}

@media (max-width:600px) { .form-card { padding:110px 25px 50px; } }
</style>
</head>
<body>
<div class="form-card">
  <div class="form-content">
    <h2>Confirma√ß√£o de Presen√ßa</h2>
    <form id="rsvpForm">
      <div class="form-grid">
        <label for="nome">Nome completo</label>
        <input type="text" name="nome" id="nome" placeholder="Nome completo" required>
		
        <label for="presenca">Presen√ßa</label>
        <select name="presenca" id="presenca" required>
          <option value="Sim" selected>Sim</option>
          <option value="N√£o">N√£o</option>
        </select>
		
		<label for="contacto" class="campo-extra">Contacto</label>
        <input type="tel" name="contacto" id="contacto" placeholder="Contacto" class="campo-extra">
		  
        <label for="num_pessoas" class="campo-extra">N√∫mero de pessoas</label>
        <input type="number" value="1" name="num_pessoas" id="num_pessoas" placeholder="N√∫mero de pessoas" min="1" class="campo-extra">

        <label for="nomes" class="campo-extra">Nomes dos acompanhantes</label>
        <input type="text" name="nomes" id="nomes" placeholder="Nomes separarados por v√≠rgula" class="campo-extra">

        <label for="criancas" class="campo-extra">Leva crian√ßas?</label>
        <select name="criancas" id="criancas" class="campo-extra">
          <option value="N√£o">N√£o</option>
          <option value="Sim">Sim</option>
        </select>

        <label for="idadesCriancas" class="campo-extra">Idade(s) da(s) crian√ßa(s)</label>
        <input type="text" name="idades_criancas" id="idadesCriancas" placeholder="Idade(s) da(s) crian√ßa(s)" class="campo-extra">

        <label for="restricoes" class="campo-extra">Restri√ß√µes alimentares (opcional)</label>
        <textarea name="restricoes" id="restricoes" placeholder="Restri√ß√µes alimentares (opcional)" class="campo-extra"></textarea>

        <button type="submit" class="enviar">Enviar confirma√ß√£o</button>
        <button type="button" class="voltar" onclick="voltarAoConvite()">‚Üê Voltar ao convite</button>

        <p class="mensagem" id="msg"></p>
      </div>
    </form>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18/build/js/utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18/build/js/intlTelInput.min.js"></script>
<script>
// ===== Fade-in =====
/*window.addEventListener("DOMContentLoaded", () => {
  document.body.style.opacity = 0;
  setTimeout(() => { document.body.style.opacity = 1; }, 50);
});*/
let iti;
document.addEventListener("DOMContentLoaded", () => {
  iti = intlTelInput(document.querySelector("#contacto"), {
    initialCountry: "pt",
    separateDialCode: true
  });
  document.body.style.opacity = 0;
  setTimeout(() => { document.body.style.opacity = 1; }, 50);
  atualizarCampos();
});

// ===== Campos din√¢micos =====
const form = document.getElementById("rsvpForm");
const presenca = document.getElementById("presenca");
const camposExtras = document.querySelectorAll(".campo-extra");
const criancas = document.getElementById("criancas");
const idades = document.getElementById("idadesCriancas");
const msg = document.getElementById("msg");
const numPessoasInput = document.getElementById("num_pessoas");
const nomesInput = document.getElementById("nomes");

function atualizarCampos() {
  const numPessoas = parseInt(numPessoasInput.value) || 1;
  // Seleciona o container do intl-tel-input
  const indicativoContainer = document.querySelector("#contacto")?.closest(".iti");
  camposExtras.forEach(c => {
    if(presenca.value === "N√£o") {
      c.classList.add("hidden");
      indicativoContainer?.classList.add("hidden");
      if(c.tagName !== "LABEL") c.required = false;
    } else {
	  // Campo "Leva crian√ßas" (criancas) s√≥ aparece se numPessoas > 1
      if(c === criancas || (c.tagName === "LABEL" && c.htmlFor === "criancas")) {
        const mostrar = numPessoas > 1;
        c.classList.toggle("hidden", !mostrar);
        if(c.tagName !== "LABEL") c.required = mostrar;
      }
      // Idades das crian√ßas
      else if(c === idades || (c.tagName === "LABEL" && c.htmlFor === "idadesCriancas")){
        const obrigatorio = criancas.value === "Sim";
        c.classList.toggle("hidden", !obrigatorio);
        if(c.tagName !== "LABEL") c.required = obrigatorio;
      }
      // Nomes acompanhantes
      else if(c === nomesInput || (c.tagName === "LABEL" && c.htmlFor === "nomes")){
        const ocultar = numPessoas <=1;
        c.classList.toggle("hidden", ocultar);
        if(c.tagName !== "LABEL") c.required = !ocultar;
      } 
      else {
        c.classList.remove("hidden");
		indicativoContainer?.classList.remove("hidden");
        if(c.name === "num_pessoas" || c.name === "criancas") c.required = true;
      }
    }
  });
}

presenca.addEventListener("change", atualizarCampos);
criancas.addEventListener("change", atualizarCampos);
numPessoasInput.addEventListener("input", atualizarCampos);
document.addEventListener("DOMContentLoaded", atualizarCampos);

// ===== Valida√ß√£o nomes =====
function validarNomesComAcompanhantes(nomePrincipal, nomesAcompanhantes, numPessoas){
  if(numPessoas <= 1) return true;
  const arr = nomesAcompanhantes.split(",").map(n=>n.trim()).filter(n=>n.length>0);
  return (1 + arr.length) === numPessoas;
}

// ===== Valida√ß√£o contacto =====
function validarContacto(tel){
  return /^(\+|00)?\d{6,15}$/.test(tel.replace(/[\s\-()]/g,''));
}
function normalizarContacto(tel){ 
	return tel.replace(/\D/g,''); 
}

// ===== Submit =====
/*form.addEventListener("submit", async function(e){
  e.preventDefault();
  msg.textContent="";

  const formData = Object.fromEntries(new FormData(form));
  const numPessoas = parseInt(formData.num_pessoas)||1;
  
  //if(formData.presenca === "Sim") {
  const dadosPais = iti.getSelectedCountryData();
  const numeroInternacional = iti.getNumber();

formData.prefixo = `+${dadosPais.dialCode}`;
formData.contacto_completo = numeroInternacional;

// ‚úÖ Verificar duplicado no backend
const resp = await fetch("https://script.google.com/macros/s/AKfycbyOWLh8rQ0ul5SNT5XRFwgUr_WkerkJKQg4oGQp9k-6lTIc5zu2Y8gkNF3c1CIZIdEuzA/exec", {
  method: "POST",
  body: JSON.stringify({ contacto_completo: formData.contacto_completo })
});

const texto = await resp.text();
const result = JSON.parse(texto);

if (result.status === "duplicate") {
  alert("Este contacto j√° confirmou presen√ßa.");
  return; // bloqueia envio
}

// üîπ Se n√£o for duplicado, continua com envio normal

  //}
  
  if(formData.presenca !== "Sim") {
    // Remove todos os campos extras se a pessoa n√£o vai
    delete formData.contacto;
    delete formData.criancas;
    delete formData.idades_criancas;
    delete formData.nomes;
    delete formData.num_pessoas;
    delete formData.restricoes; // se quiser opcional
	//delete formData.prefixo;
  } else {
    //formData.contacto = normalizarContacto(formData.contacto);
    
    // Validar nomes se houver acompanhantes
    if(numPessoas > 1){
      if(!validarNomesComAcompanhantes(formData.nome, formData.nomes, numPessoas)){
        alert(`O n√∫mero de nomes n√£o corresponde ao n√∫mero de pessoas (${numPessoas}). O seu nome principal conta como 1 pessoa.`);
		return;
      }
    }
  }

  // Enviar para Google Apps Script
  try {
    const resp = await fetch("https://script.google.com/macros/s/AKfycbyOWLh8rQ0ul5SNT5XRFwgUr_WkerkJKQg4oGQp9k-6lTIc5zu2Y8gkNF3c1CIZIdEuzA/exec", {
      method:"POST",
      body: JSON.stringify(formData)
    });
	const texto = await resp.text();
	console.log("Resposta crua:", texto);
  let result;
  try {
    result = JSON.parse(texto);
  } catch {
    throw new Error("Resposta inv√°lida do servidor");
  }

  if (result.status === "duplicate") {
    alert("Contacto j√° registado");
    return;
  }

  if (result.status === "error") {
    alert(result.message || "Erro ao enviar");
    return;
  }

  if (result.status === "ok") {
    alert("Confirma√ß√£o registada! A redirecionar...");
    form.reset();
    atualizarCampos();
    voltarAoEnvelope();
  }

} catch (err) {
  console.error(err);
  alert("Erro de comunica√ß√£o com o servidor");
}
});*/
form.addEventListener("submit", async function(e){
  e.preventDefault();
  msg.textContent = "";

  // 1Ô∏è‚É£ Preparar dados
  const formData = Object.fromEntries(new FormData(form));

  const numPessoas = parseInt(formData.num_pessoas) || 1;

  if(formData.presenca === "Sim"){
    if(!iti.isValidNumber()){
      alert("Contacto inv√°lido. Verifique o n√∫mero.");
      return;
    }

    const dadosPais = iti.getSelectedCountryData();
    const numeroInternacional = iti.getNumber();

    formData.prefixo = `+${dadosPais.dialCode}`;
    formData.contacto_completo = numeroInternacional;
    //formData.contacto = numeroInternacional.replace(/\D/g,'').slice(dadosPais.dialCode.length);

    // 2Ô∏è‚É£ Validar nomes se houver acompanhantes
    if(numPessoas > 1){
      const arr = (formData.nomes || "").split(",").map(n=>n.trim()).filter(n=>n.length>0);
      if(1 + arr.length !== numPessoas){
        alert(`O n√∫mero de nomes n√£o corresponde ao n√∫mero de pessoas (${numPessoas}).`);
        return;
      }
    }
  }

  // 3Ô∏è‚É£ Enviar para Apps Script
  try {
    const resp = await fetch("https://script.google.com/macros/s/AKfycbyOWLh8rQ0ul5SNT5XRFwgUr_WkerkJKQg4oGQp9k-6lTIc5zu2Y8gkNF3c1CIZIdEuzA/exec", {
      method: "POST",
      body: JSON.stringify(formData)
    });

    const texto = await resp.text();
    let result;
    try { result = JSON.parse(texto); } catch { throw new Error("Resposta inv√°lida"); }

    // 4Ô∏è‚É£ Verificar duplicado
    if(result.status === "duplicate"){
      alert("Este contacto j√° confirmou presen√ßa.");
      return;
    }

    if(result.status === "error"){
      alert(result.message || "Erro ao enviar");
      return;
    }

    if(result.status === "ok"){
      alert("Confirma√ß√£o registada! A redirecionar...");
      form.reset();
      atualizarCampos();
      voltarAoEnvelope();
    }

  } catch(err){
    console.error(err);
    alert("Erro de comunica√ß√£o com o servidor");
  }
});

// ===== Voltar =====
function voltarAoConvite(){
	document.body.style.opacity=0; 
	setTimeout(()=>{window.location.href="index.html#convite";},1000);
}
function voltarAoEnvelope(){
	setTimeout(() => {
    document.body.style.opacity = 0;
    setTimeout(() => {
      window.location.href = "index.html";
    }, 2000); // tempo do fade
  }, 100); // pequeno delay ap√≥s fechar o alert
}
async function verificarDuplicado(contactoCompleto) {
  try {
    const resp = await fetch("https://script.google.com/macros/s/AKfycbzbYA0XvS1gRPbvt04a5nhCwGUc0PWiOhc25PFnvbtkDq5y2kyFNVSL2QSxEhTu-F-cEQ/exec", {
      method: "POST",
      body: JSON.stringify({
        acao: "verificar",
        contacto_completo: contactoCompleto
      })
    });

    const texto = await resp.text();
    const result = JSON.parse(texto);

    return result.exists === true;

  } catch (err) {
    console.error(err);
    return false; // em caso de erro, deixa passar
  }
}

</script>
</body>
</html>

































