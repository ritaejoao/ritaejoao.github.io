<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18/build/css/intlTelInput.css">
<title>Rita & João | Confirmação de Presença</title>
<link rel="stylesheet" href="style_rsvp.css">
</head>

<body>
<div class="form-card">
  <div class="form-content">
    <h2>Confirmação de Presença</h2>
    <form id="rsvpForm">
	  <!-- Honeypot (invisível) -->
	<input type="text" name="website" style="display:none" autocomplete="off">

	  <!-- Token secreto -->
	<input type="hidden" name="token" value="rsvp-rita-joao-2026">
      <div class="form-grid">
        <label for="nome">Nome *</label>
        <input type="text" name="nome" id="nome" placeholder="Nome" required>
		
        <label for="presenca">Presença *</label>
        <select name="presenca" id="presenca" required>
          <option value="Sim" selected>Sim</option>
          <option value="Não">Não</option>
        </select>
		
		<label for="contacto" class="campo-extra">Contacto *</label>
        <input type="tel" name="contacto" id="contacto" placeholder="Contacto" class="campo-extra">

        <label for="num_pessoas" class="campo-extra num_pessoas">Número de pessoas *</label>
        <input type="number" value="1" name="num_pessoas" id="num_pessoas" placeholder="Número de pessoas" min="1" class="campo-extra">

        <label for="nomes" class="campo-extra">Nomes dos acompanhantes *</label>
        <input type="text" name="nomes" id="nomes" placeholder="Ex: Ana, Maria, (incluir nomes das crianças)" class="campo-extra">
		  
		<label for="pequenoCafe" class="campo-extra">Pequeno-almoço *</label>
		<select name="pequeno_cafe" id="pequenoCafe" class="campo-extra">
		  <option value="Sim" selected>Sim</option>
		  <option value="Não">Não</option>
		</select>

        <label for="criancas" class="campo-extra">Leva crianças? *</label>
        <select name="criancas" id="criancas" class="campo-extra">
          <option value="Não">Não</option>
          <option value="Sim">Sim</option>
        </select>

        <label for="idadesCriancas" class="campo-extra">Quantas e qual a idade? *</label>
        <input type="text" name="idades_criancas" id="idadesCriancas" placeholder="Ex: 2 crianças - 4 e 7 anos" class="campo-extra">

        <label for="restricoes" class="campo-extra">Restrições alimentares (opcional)</label>
        <textarea name="restricoes" id="restricoes" placeholder="Ex: intolerâncias alimentares, dieta, vegetariano " class="campo-extra"></textarea>

        <button type="submit" class="enviar">Enviar confirmação</button>
        <button type="button" class="voltar" onclick="voltarAoConvite()">← Voltar ao convite</button>

        <p class="mensagem" id="msg"></p>
      </div>
    </form>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18/build/js/utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18/build/js/intlTelInput.min.js"></script>
<script>
let iti;
document.addEventListener("DOMContentLoaded", () => {
  iti = intlTelInput(document.querySelector("#contacto"), {
    initialCountry: "pt",
    separateDialCode: true
  });
  document.body.style.opacity = 0;
  setTimeout(() => { document.body.style.opacity = 1; }, 50);
  atualizarCampos();
});

// ===== Campos dinâmicos =====
const form = document.getElementById("rsvpForm");
const presenca = document.getElementById("presenca");
const camposExtras = document.querySelectorAll(".campo-extra");
const criancas = document.getElementById("criancas");
const idades = document.getElementById("idadesCriancas");
const msg = document.getElementById("msg");
const numPessoasInput = document.getElementById("num_pessoas");
const nomesInput = document.getElementById("nomes");

function atualizarCampos() {
  const numPessoas = parseInt(numPessoasInput.value) || 1;
  // Seleciona o container do intl-tel-input
  const indicativoContainer = document.querySelector("#contacto")?.closest(".iti");
  camposExtras.forEach(c => {
    if(presenca.value === "Não") {
      c.classList.add("hidden");
      indicativoContainer.classList.add("hidden");
      if(c.tagName !== "LABEL") c.required = false;
    } else {
	  // Campo "Leva crianças" (criancas) só aparece se numPessoas > 1
      if(c === criancas || (c.tagName === "LABEL" && c.htmlFor === "criancas")) {
        const mostrar = numPessoas > 1;
        c.classList.toggle("hidden", !mostrar);
        if(c.tagName !== "LABEL") c.required = mostrar;
      }
      // Idades das crianças
      else if(c === idades || (c.tagName === "LABEL" && c.htmlFor === "idadesCriancas")){
        const obrigatorio = criancas.value === "Sim";
        c.classList.toggle("hidden", !obrigatorio);
        if(c.tagName !== "LABEL") c.required = obrigatorio;
      }
      // Nomes acompanhantes
      else if(c === nomesInput || (c.tagName === "LABEL" && c.htmlFor === "nomes")){
        const ocultar = numPessoas <=1;
        c.classList.toggle("hidden", ocultar);
        if(c.tagName !== "LABEL") c.required = !ocultar;
      }
	  else if(c === contacto || (c.tagName === "LABEL" && c.htmlFor === "contacto")){
        const obrigatorio = presenca.value === "Sim";
        c.classList.toggle("hidden", !obrigatorio);
        if(c.tagName !== "LABEL") c.required = obrigatorio;
      }
      else {
        c.classList.remove("hidden");
		indicativoContainer.classList.remove("hidden");
        if(c.name === "num_pessoas" || c.name === "criancas") c.required = true;
		if(c.tagName !== "LABEL") c.required = (c.name === "pequeno_cafe") ? true : c.required;
      }
    }
  });
}

presenca.addEventListener("change", atualizarCampos);
criancas.addEventListener("change", atualizarCampos);
numPessoasInput.addEventListener("input", atualizarCampos);
document.addEventListener("DOMContentLoaded", atualizarCampos);

// ===== Validação nomes =====
function validarNomesComAcompanhantes(nomePrincipal, nomesAcompanhantes, numPessoas){
  if(numPessoas <= 1) return true;
  const arr = nomesAcompanhantes.split(",").map(n=>n.trim()).filter(n=>n.length>0);
  return (1 + arr.length) === numPessoas;
}

form.addEventListener("submit", async function(e){
  e.preventDefault();
  //msg.textContent = "";
  // Mostrar loading imediatamente
  msg.textContent = "⏳ A enviar confirmação…";
  msg.style.color = "#333";  // cor neutra para loading

  // Desativa o botão para evitar múltiplos cliques
  const btn = form.querySelector("button.enviar");
  btn.disabled = true;
try {
  // 1️⃣ Preparar dados
  const formData = Object.fromEntries(new FormData(form));
  // 1️⃣ Honeypot
	if(formData.website){  // se preenchido, é bot
	  alert("Spam detectado. Submissão bloqueada.");
	  btn.disabled = false;
	  return;
	}

  // 2️⃣ Token secreto
	if(formData.token !== "rsvp-rita-joao-2026"){
	  alert("Token inválido. Submissão bloqueada.");
	  btn.disabled = false;
	  return;
	}
  const numPessoas = parseInt(formData.num_pessoas) || 1;

  if(formData.presenca === "Sim"){
    if(!iti.isValidNumber()){
      alert("Contacto inválido. Verifique o número.");
	  btn.disabled = false;
       msg.textContent = "";
      return;
    }

    const dadosPais = iti.getSelectedCountryData();
    const numeroInternacional = iti.getNumber();

    formData.prefixo = `+${dadosPais.dialCode}`;
    formData.contacto_completo = numeroInternacional.replace(/\D/g,''); // remove +, espaços, etc.
    //formData.contacto = numeroInternacional.replace(/\D/g,'').slice(dadosPais.dialCode.length);
	const existe = await verificarDuplicado(formData.contacto_completo);
	if(existe){
	  alert("Este contacto já confirmou presença.");
	  btn.disabled = false;
      msg.textContent = "";
	  return; // BLOQUEIA envio
	}

    // 2️⃣ Validar nomes se houver acompanhantes
    if(numPessoas > 1){
      const arr = (formData.nomes || "").split(",").map(n=>n.trim()).filter(n=>n.length>0);
      if(1 + arr.length !== numPessoas){
        alert(`O número de nomes não corresponde ao número de pessoas, que são ${numPessoas}.`);
		btn.disabled = false;
        msg.textContent = "";
        return;
      }
    }
	if(numPessoas === 1) {
	  delete formData.criancas;
	  delete formData.idades_criancas; // remove também idades, se houver
	}
  }
  if(formData.presenca !== "Sim") {
		delete formData.contacto;
		delete formData.criancas;
		delete formData.idades_criancas;
		delete formData.nomes;
		delete formData.num_pessoas;
		delete formData.restricoes;
		delete formData.prefixo;
		delete formData.pequeno_cafe; // <- campo novo
	}

  // 3️⃣ Enviar para Apps Script
  
    const resp = await fetch("https://script.google.com/macros/s/AKfycbxZw0jnLsjZPQg0dSPid8kNs01Lw1K6VAFjxt3UpVj17U6FZbCCgEjjH7683aN_ez9YyA/exec", {
      method: "POST",
      body: JSON.stringify(formData)
    });

    const texto = await resp.text();
    let result;
    try { result = JSON.parse(texto); } catch { throw new Error("Resposta inválida"); }

    // 4️⃣ Verificar duplicado
    if(result.status === "duplicate"){
      alert("Este contacto já confirmou presença.");
	  btn.disabled = false;
      msg.textContent = "";
      return;
    }

    if(result.status === "error"){
      alert(result.message || "Erro ao enviar");
	  btn.disabled = false;
       msg.textContent = "";
      return;
    }

    if(result.status === "ok"){
      //alert("Confirmação registada! A redirecionar...");
	  if(formData.presenca === "Sim"){
		msg.textContent = "Que alegria saber que estarão connosco! Obrigado por fazerem parte deste dia tão especial.";
		msg.style.color = "black";
		form.reset();
		atualizarCampos();
		//voltarAoEnvelope();
		setTimeout(voltarAoEnvelope, 7000);
	  } else {
		msg.textContent = "Compreendemos a vossa ausência e agradecemos desde já o carinho.";
		msg.style.color = "black";
		setTimeout(voltarAoEnvelope, 7000);
	   }
    }

  } catch(err){
    console.error(err);
    alert("Erro de comunicação com o servidor");
	btn.disabled = false;
    msg.textContent = "";
  }
});

// ===== Voltar =====
function voltarAoConvite(){
	document.body.style.opacity=0; 
	setTimeout(()=>{window.location.href="index.html#convite";},1000);
}
function voltarAoEnvelope(){
	setTimeout(() => {
    document.body.style.opacity = 0;
    setTimeout(() => {
      window.location.href = "index.html";
    }, 2000); // tempo do fade
  }, 100); // pequeno delay após fechar o alert
}
async function verificarDuplicado(contactoCompleto) {
  try {
    const resp = await fetch("https://script.google.com/macros/s/AKfycbxZw0jnLsjZPQg0dSPid8kNs01Lw1K6VAFjxt3UpVj17U6FZbCCgEjjH7683aN_ez9YyA/exec", {
      method: "POST",
      body: JSON.stringify({
        acao: "verificar",
        contacto_completo: contactoCompleto.replace(/\D/g,'') // normaliza também
      })
    });

    const texto = await resp.text();
    const result = JSON.parse(texto);

    return result.exists;

  } catch (err) {
    console.error(err);
    return false; // em caso de erro, deixa passar
  }
}
/*
// Função de teste do formulário
function testarFormulario() {
  const form = document.getElementById("rsvpForm");
  
  // Lista de testes simulados
  const testes = [
    {desc: "Honeypot preenchido", overrides: {website: "spam"}},
    {desc: "Token inválido", overrides: {token: "xpto"}},
    {desc: "Contacto inválido", overrides: {contacto: "123"}},
    {desc: "Número de acompanhantes errado", overrides: {num_pessoas: 3, nomes: "Ana, Maria"}},
    {desc: "ReCAPTCHA não preenchido", overrides: {grecaptchaResponse: ""}},
    {desc: "Tudo correto", overrides: {num_pessoas:1, nomes:"", contacto:"912345678", token:"rsvp-rita-joao-2026", grecaptchaResponse:"dummy"}}
  ];

  testes.forEach((teste,i) => {
    console.log(`\n=== Teste ${i+1}: ${teste.desc} ===`);

    // Pega os dados atuais do formulário
    const formData = Object.fromEntries(new FormData(form));

    // Substitui campos conforme o teste
    Object.assign(formData, teste.overrides);

    // 1️⃣ Honeypot
    if(formData.website){
      console.log("❌ Spam detectado (honeypot). Alerta disparado.");
      return;
    }

    // 2️⃣ Token
    if(formData.token !== "rsvp-rita-joao-2026"){
      console.log("❌ Token inválido. Alerta disparado.");
      return;
    }

    // 3️⃣ Contacto
    if(formData.contacto && formData.contacto.length < 9){
      console.log("❌ Contacto inválido. Alerta disparado.");
      return;
    }

    // 4️⃣ Nomes acompanhantes
    const numPessoas = parseInt(formData.num_pessoas) || 1;
    if(numPessoas > 1){
      const arr = (formData.nomes||"").split(",").map(n=>n.trim()).filter(n=>n);
      if(arr.length + 1 !== numPessoas){
        console.log(`❌ Nomes acompanhantes incorretos. Alerta disparado.`);
        return;
      }
    }

    // 5️⃣ ReCAPTCHA
    if(!formData.grecaptchaResponse){
      console.log("❌ ReCAPTCHA não preenchido. Alerta disparado.");
      return;
    }

    console.log("✅ Todos os campos corretos. Formulário poderia ser enviado.");
  });
}

// Rodar os testes ao carregar a página
document.addEventListener("DOMContentLoaded", testarFormulario);
*/
</script>
</body>
</html>




